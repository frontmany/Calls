# –ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ —Å–µ—Ä–≤–µ—Ä–∞

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- ‚úÖ `IUserRepository` - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- ‚úÖ `IPacketSender` - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
- ‚úÖ `ICallManager` - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞–º–∏

### 2. –°–æ–∑–¥–∞–Ω—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ `UserRepository` - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ `CallManager` - –º–µ–Ω–µ–¥–∂–µ—Ä –∑–≤–æ–Ω–∫–æ–≤
- ‚úÖ `NetworkPacketSender` - –∞–¥–∞–ø—Ç–µ—Ä NetworkController –∫ IPacketSender
- ‚úÖ `MediaRelayService` - —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –º–µ–¥–∏–∞ (voice/screen/camera)

### 3. –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- ‚úÖ `handleVoice`, `handleScreen`, `handleCamera` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç `MediaRelayService`
- ‚úÖ –£–±—Ä–∞–Ω–æ ~60 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞

### 4. –ù–∞—á–∞—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è Server
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `server.h` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã:
  - `onReceive` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_userRepository`
  - `handleVoice`, `handleScreen`, `handleCamera` - –∏—Å–ø–æ–ª—å–∑—É—é—Ç `MediaRelayService`
  - `redirect` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_userRepository` –∏ `m_packetSender`
  - `handleAuthorization` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_userRepository` –∏ `m_packetSender`
  - –ß–∞—Å—Ç–∏—á–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (callbacks –¥–ª—è connection down/restored)

## ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

### –ú–∏–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤ Server
‚úÖ –í—Å–µ –º–µ—Ç–æ–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤:
- ‚úÖ `handleConfirmation` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_userRepository`
- ‚úÖ `handleLogout` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_userRepository` –∏ `m_packetSender`
- ‚úÖ `handleReconnect` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_userRepository`, `m_callManager`, `m_packetSender`
- ‚úÖ `handleGetFriendInfo` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_userRepository` –∏ `m_packetSender`
- ‚úÖ `handleStartOutgoingCall` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_userRepository`, `m_callManager`, `m_packetSender`
- ‚úÖ `handleStopOutgoingCall` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_userRepository` –∏ `m_packetSender`
- ‚úÖ `handleAcceptCall` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_userRepository`, `m_callManager`, `m_packetSender`
- ‚úÖ `handleDeclineCall` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_userRepository` –∏ `m_packetSender`
- ‚úÖ `handleEndCall` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_userRepository`, `m_callManager`, `m_packetSender`
- ‚úÖ `processUserLogout` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_userRepository`, `m_callManager`
- ‚úÖ `resetOutgoingPendingCall` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_callManager`
- ‚úÖ `removeIncomingPendingCall` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_callManager`
- ‚úÖ `sendPacketTask` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_packetSender`
- ‚úÖ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (callbacks) - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `m_userRepository` –∏ `m_callManager`

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è –º–µ—Ç–æ–¥–æ–≤ Server** - –ó–ê–í–ï–†–®–ï–ù–û
   - ‚úÖ –í—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `m_endpointToUser` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `m_userRepository.findUserByEndpoint()`
   - ‚úÖ –í—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `m_nicknameHashToUser` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `m_userRepository.findUserByNickname()`
   - ‚úÖ –í—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `m_calls` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `m_callManager.createCall()` / `m_callManager.endCall()`
   - ‚úÖ –í—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `m_pendingCalls` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `m_callManager.addPendingCall()` / `m_callManager.removePendingCall()`

2. ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CallManager** - –ó–ê–í–ï–†–®–ï–ù–û
   - ‚úÖ `createCall` ‚Üí `m_callManager.createCall()`
   - ‚úÖ `endCall` ‚Üí `m_callManager.endCall()`
   - ‚úÖ `getCallPartner` ‚Üí `m_callManager.getCallPartner()`

3. ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤** - –ó–ê–í–ï–†–®–ï–ù–û
   - ‚úÖ –í—Å–µ `m_networkController.send()` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `m_packetSender.send()`

4. ‚úÖ **–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —á–ª–µ–Ω–æ–≤ –∫–ª–∞—Å—Å–∞** - –ó–ê–í–ï–†–®–ï–ù–û
   - ‚úÖ –ü—Ä—è–º—ã–µ –º–∞–ø—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ Server (—Ç–µ–ø–µ—Ä—å –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö)

5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¢–†–ï–ë–£–ï–¢–°–Ø
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–µ—Ç —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å thread-safety
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∑–≤–æ–Ω–∫–æ–≤

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤**: 7 (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã + —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
- **–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**: ~60 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
- **–û–±–Ω–æ–≤–ª–µ–Ω–æ –º–µ—Ç–æ–¥–æ–≤**: 20+ –º–µ—Ç–æ–¥–æ–≤
- **–ó–∞–º–µ–Ω–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π —Å—Ç–∞—Ä—ã—Ö –º–∞–ø–æ–≤**: 64+ –º–µ—Å—Ç
- **–£–¥–∞–ª–µ–Ω–æ –ø—Ä—è–º—ã—Ö –º–∞–ø–æ–≤ –∏–∑ Server**: 4 (m_endpointToUser, m_nicknameHashToUser, m_calls, m_pendingCalls)

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** - –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ—é –æ–±–ª–∞—Å—Ç—å
2. **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è** - MediaRelayService –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –º–µ–¥–∏–∞
3. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –º–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è unit-—Ç–µ—Å—Ç–æ–≤
4. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å** - –∫–æ–¥ —Å—Ç–∞–ª –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º
